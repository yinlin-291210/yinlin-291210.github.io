---
layout: post
title: "了解http连接"
subtitle: "HTTP Connect"
date: 2023-03-01 11:19:51
author: linbao
header-img:
catalog: true
tags:
  - http
---

# 20220429-钱佳豪-了解 http 连接

# 了解 HTTP 的连接

HTTP 协议他的传输是通过 TCP/IP 实现的，这个大家都是稍有耳闻，而我们对这个过程是不是非常了解，这篇分享就是让大家对 http 的连接有一些具体的认识

> 世界上几乎所有的 HTTP 通信都是由 TCP/IP 承载的，HTTP 数据通过 TCP/IP 传到世界另一头的主机。

#### HTTP 和 TCP/IP

> TCP/IP 真的就是一个协议吗，答案：不是，他们是许多协议的集合，其中包含了 UDP、DNS、ARP 等协议,其中 TCP 和 IP 协议最具代表性。

![](/img/in-post/http-connect/371b9ab638a91223ad73f3e70537ea9b6f9de4b4178ee8653659815a29272627QzpcVXNlcnNcYWRtaW5cQXBwRGF0YVxSb2FtaW5nXERpbmdUYWxrXDg4NDgwMjE3N192MlxJbWFnZUZpbGVzXDE2NTgzMzA1MlwxNjUxMDM3OTExODY3X0FBRDk1MEFCLThCOTAtNGViMi05RkJDLUI1M0I0NERGMDEyOS5wbmc%3D.png)

图(a)可以看到，首先应用层 HTTP 协议将我们的行为和信息包装总结为 HTTP 报文（xmlhttprequest），然后交由传输层，使用 TCP 协议进行连接的建立并且对数据进行处理，由 IP 协议完成传输。,我们可以发现上层的协议都是基于下层协议实现的。这个地方可能有点问题，为什么是 IP 协议进行传输的呢?

> 举个例子，我们如果向世界另一边送一个东西，我们不可能靠脚走过去把，我们会将物品包装交给快递员，那这个快递员会用脚给我送过去吗，更不可能，快递会使用交通工具将物品送达，这个过程中，我们本身是 HTTP 协议，快递员就是 TCP 协议，而交通工具就是 IP 协议。

图(b)https 就是封装了一个安全层，在传输层和应用层之间进行网络加密。

#### TCP 和 IP

##### IP 协议

> ip 协议为主机分配 IP 地址，基于 IP 地址实现了寻址功能，并且使网络层和底层之间减少耦合。根据端到端的设计原则，ip 协议为主机提供一种无连接、不可靠的、尽力而为的数据包传输服务。IP 协议处于网络层，他提供的是主机和主机之间的通信。

主机自己有唯一的 MAC 地址，为什么还需要 IP 地址呢？

- 首先是需要解耦，我们在网络层使用 IP 地址，在数据链路层我们使用 MAC 地址，每层都是用各自的标识。
- 如果我们不使用 IP 地址,我们就需要维护一个拥有所有 MAC 地址的映射表（如果没有这张表，主机会向世界所有主机进行广播，问谁是这个 mac 地址），这样会大大增加网络消耗，而我们使用根据主机所处网段，然后分配 IP 地址，那么我们就可以根据 IP 地址找到目标主机对应的区域，然后让区域内部路由对应的主机。（这个机制有点像我们生活中快递的中转站，我们只要将快递送到中转站，剩下的工作由中转站来做。）
- 灵活性，如果我们使用了 mac 地址这种标识，在网络层中 mac 固定不变，这种不利于我们管理设备，我们应该根据位置动态分配。比如
  如果需要要求某一子网下买一个厂商制造的设备（对地址格式有要求），要么你就需要要求厂商在生产网络设备烧录 MAC 地址时，提前按照你规划好的子网结构来定 MAC 地址，并且日后这个网络的结构都不能轻易改变。

##### TCP 协议

> TCP 协议，中文名传输控制协议， 是面向连接，稳定可靠的，有序的，是属于传输层的。他是在主机和主机通信的基础上，进行端口的通信。

< 源 IP 地址、源端口号、目的 IP 地址、目的端口号> 这四个值定义了一条连接，两条不同的 tcp 连接不能拥有四个完全相同的地址组件值，这些信息通信端都会保存下来。

为什么 TCP 基于 IP 实现，为什么 TCP 和 IP 会截然不同呢？

> 连接是一种有来有回的交互。IP 协议是一种发出去不期待响应也没有响应的传输，IP 协议只做了发送这个行为。TCP 在其基础上建立了发出并且期待响应的一种交互机制。这种连接其实就是维护了状态，TCP 对连接状态进行管理(通信双方都需要维护连接的信息),双方会保存双方的信息，并且知道连接方是谁也知道对方的状态，维护主机端口之间的连接状态（传输层）。
> 好比我刚进入公司，我知道组里有个人叫 XXX，路上遇到，我和他打招呼，但是他并不知道我是谁，以为我在跟别人说话，只是听到了没做出回应，如果我们两个互相认识一下，他记住了我名字，并且觉得我这人不错可以交流沟通，下次我向他打招呼时，他就知道我是在和他说话，他对我有好印象也会给我回应，我们之间就建立了一个连接。如果我在他那里有一天印象变成了人品不好不值得沟通，我就算和他打招呼，他也不会对我进行回应，我在他哪里的状态就是不可沟通。

> 我们常说的 HTTP 短连接和长连接，就是对状态的维护，是持久的还是一次事务结束就不维护了。serve 端的 session，client 端的 cookie 就是对连接双方的状态进行了持久化保存，维护了用户的登录状态，（应用层）。

> 有序和稳定可靠，TCP 是通过了快速重传和超时重传，因为 TCP 要求接收方接收到信息，需要向发送方发一个确认信息，如果迟迟收不到，或者确认信息告诉我数据有问题，发送方就会进行重传，然后通过序列号来保证他的有序性。

TCP 协议就是一个状态机，他根据情况切换自己的状态，根据不同状态做出不同的行为，双方主机的 TCP 会根据不同的状态进行不同的操作，比如如果接收方时无连接状态，这时候数据接收方都会拒绝，这时候如果是三次握手请求建立连接，接收方才会处理。

TCP 对应的 UDP，他们两个像是互补一样，TCP 基于 IP 协议基本实现了所有功能，而 UDP 几乎没有做什么特别的事情。

##### 数据的传输过程

> 发送发数据的封装是从上往下的，而接收方是从下往上解析数据的。

![](/img/in-post/http-connect/Image%20%5B2%5D.png)

##### TCP/IP 传输的格式

首先，TCP 的数据是通过名为  IP 分组（或  IP 数据报）的小数据块来发送的。HTTP 要传送一条报文时，会以流的形式将报文数据的内容通过一条打开的 TCP 连接按序传输。TCP 收到数据流之后，会将数据流砍成被称作段的小数据块，并将段封装在 IP 分组中，通过因特网进行传输。所有这些工作都是由 TCP/IP 软件来处理的，HTTP 程序员什么都看不到。

结构上是首部 - 内容 ，内容中套首部 -内容。这里 ip 分组包含 tcp 段，这种格式又体现了上层协议是基于下层协议实现的，因为 TCP 的数据是在在 IP 分组的内容部分，并没有破坏 IP 分组的格式。

> 协议和协议之间有协作关系，但是他们互不影响各自的协议的逻辑。

![](/img/in-post/http-connect/2ea0e5bda57da606a6a83c9aca00b98f6bb25be025af191706f5a63b1d7e0f4eQzpcVXNlcnNcYWRtaW5cQXBwRGF0YVxSb2FtaW5nXERpbmdUYWxrXDg4NDgwMjE3N192MlxJbWFnZUZpbGVzXDE2NTgzMzA1MlwxNjUxMDM3ODQ2NjAzX0VEQjUwQzQ2LUM2QzMtNDExZi05RDIwLTcxQzczQzM3RUU3Ri5wbmc%3D.png)

#### 总结

传输层解决的是进程间的通信的问题，一般用端口标识进程；网络层解决的是主机之间通信的问题，数据报在传输过程中源主机 IP 和目标主机 IP 是不变的，理论上 IP 是唯一的；链路层解决的是相邻的主机、路由器之间的数据传输，mac 地址在每一段链路上都会发生变化。
HTTP 是使用 TCP/IP 进行传输的，TCP 协议是基于 IP 协议传输，所以他们之间的关系不应该用协议名字去划分，应该是根据所处层级和相对关系，对于 HTTP 而言，TCP 是连接传输数据的，TCP 和 IP 之间一个是维护状态连接，一个是进行传输。
